# 谷歌风格 Python 注释（Docstring）规范

本指南介绍如何在 Python 项目中编写 **Google Style** 的文档字符串（docstring），便于团队协作、自动文档生成（例如配合 *mkdocstrings*、*Sphinx*、*pdoc* 等工具）以及静态分析。

---

## 1. 适用范围

应为以下对象编写 docstring：

* 模块（文件首行）
* 公共类、函数、方法
* 重要的内部函数（逻辑复杂、算法关键）
* 包的 `__init__.py`（可选，用于总体说明）

不建议为：

* 非公共的、极其短小且语义自明的函数（如一行 `wrap()` 直接调用其它函数）
* Getter/Setter（若仅简单返回/赋值）

---

## 2. 通用格式结构

```python
def function(arg1: int, arg2: str = "x") -> bool:
	"""一句话概要，句号结尾。

	可选的详细描述，说明背景、算法思路、注意事项等，可多段。首行与详细描述之间留一空行。

	Args:
		arg1 (int): 参数意义，必要信息（单位、取值范围、是否可为 None）。
		arg2 (str, optional): 说明可选参数，列出默认值与用法。

	Returns:
		bool: 返回值含义，如有多种情况说明判定逻辑。

	Raises:
		ValueError: 触发条件。
		RuntimeError: 其它异常情况。

	Example:
		>>> function(3, "a")
		True
	"""
	...
```

### 2.1 模块级 docstring

置于文件第一行，用于说明模块用途、整体设计、主要公开 API、依赖、简单示例。

```python
"""信道仿真模块。

实现：
1. 多径瑞利信道模型
2. AWGN 噪声叠加
3. 相位噪声与频偏模拟

示例:
	>>> from sim.channel import build_channel
	>>> ch = build_channel("rayleigh", paths=6)
	>>> ch.process(signal)
"""
```

### 2.2 类的 docstring

包含概述 + 可选的属性说明（Attributes）+ 可选示例。

```python
class Packet:
	"""物理层仿真数据包。

	Attributes:
		bits (list[int]): 原始信息比特。
		fec_rate (float): FEC 编码码率，范围 (0,1]。
		timestamp (float | None): 生成时间戳，可能为空。
	"""
```

如果初始化参数较多，优先在 `__init__` 方法写 docstring（或在类 docstring 中的 Args 段）。不要两个地方重复冗长说明，避免漂移。

### 2.3 `__init__` 与工厂方法

`__init__` 的 docstring 描述初始化参数，不再赘述返回值（Python 始终返回 `None`）。

```py
class SimOptions:
	"""仿真参数集合。"""

	def __init__(
		self,
		pkt_len_var: "tk.Variable",
		conv_code_rate_var: "tk.Variable",
		interleave_bits_var: "tk.Variable",
		modulation_var: "tk.Variable",
		# ... 其余参数 ...
	) -> None:
		"""构建仿真参数对象。

		Args:
			pkt_len_var (tk.Variable): 包长度（字节）。
			conv_code_rate_var (tk.Variable): 卷积码率（如 1/2, 3/4）。
			interleave_bits_var (tk.Variable): 交织深度（正整数）。
			modulation_var (tk.Variable): 调制方式（'BPSK'/'QPSK'/...）。
		"""
		...
```

---

## 3. 各段落规则说明

| 段落 | 是否必需 | 说明 |
|------|----------|------|
| 概要（Summary line） | 是 | 第一行。简短、祈使或陈述语。 |
| 详细描述 | 否 | 与概要之间空一行。可多段。 |
| Args | 视情况 | 有参数则写；每行 `name (type): 描述`。 |
| Attributes | 否 | 用于类公共属性。 |
| Returns | 函数/方法返回非 None | 单值：`type: 描述`；多值：列出或用 `Tuple[...]`。 |
| Yields | 生成器 | 与 Returns 互斥。 |
| Raises | 函数可能抛出异常 | 枚举具体异常类型。 |
| Example / Examples | 否 | Doctest 形式，或多示例加小标题。 |
| Note / Notes | 否 | 额外说明；可使用 reST 标记。 |
| Warning | 否 | 强调危险或易错点。 |

> 命名：单示例用 `Example:`，多个用 `Examples:`。Doctest 行前以 `>>>`；多行输出继续使用 `...`。

---

## 4. 参数与类型书写建议

1. **类型来源**：优先使用标准库类型提示（`int`, `float`, `str`, `list[int]`, `dict[str, Any]`）。
2. **可选值**：可列出枚举：`modulation (str): 调制方式，可选 {'BPSK','QPSK','16QAM'}`。
3. **可为 None**：使用 `| None`（Python 3.10+），或 `Optional[int]`。
4. **联合类型**：`int | float`；复杂结构可引用自定义 `TypedDict` / `Protocol`。
5. **布尔**：描述触发条件：`enable_crc (bool): 是否启用 CRC 校验。`。
6. **单位**：在描述末尾补充，如：`freq_offset_hz (float): 载波频偏 (Hz)`。

---

## 5. 返回值与生成器

单一返回：
```python
def mean(values: list[float]) -> float:
	"""计算均值。

	Args:
		values (list[float]): 数值序列，非空。

	Returns:
		float: 均值。
	"""
```

多个返回值：
```python
def stats(values: list[float]) -> tuple[float, float]:
	"""返回均值与方差。

	Args:
		values (list[float]): 数值序列。

	Returns:
		tuple[float, float]: (均值, 方差)。
	"""
```

生成器：
```python
def read_packets(stream: bytes) -> Iterator[bytes]:
	"""逐包解析。

	Yields:
		bytes: 下一数据包。
	"""
```

---

## 6. 异常说明 (Raises)

仅列出**主动抛出**或**调用者必须处理**的异常。

```python
def divide(a: float, b: float) -> float:
	"""除法。

	Args:
		a (float): 被除数。
		b (float): 除数，非 0。

	Raises:
		ZeroDivisionError: 当 b == 0。

	Returns:
		float: 商。
	"""
	if b == 0:
		raise ZeroDivisionError("division by zero")
	return a / b
```

---

## 7. 示例 (Example / Examples)

* 保持可复制、可运行。
* 对随机函数，固定种子或给出确定输出。
* 对长输出可使用省略号：`# doctest: +ELLIPSIS`（某些测试框架支持）。

```python
def encode(bits: list[int]) -> list[int]:
	"""简单重复编码。

	Example:
		>>> encode([1, 0])
		[1, 1, 0, 0]
	"""
	return [b for bit in bits for b in (bit, bit)]
```

---

## 8. 属性 (Attributes) 与数据类

当类属性多、逻辑简单时，可考虑 `@dataclass`，减少样板代码，同时保持 docstring 清晰：

```python
from dataclasses import dataclass

@dataclass
class SimConfig:
	"""仿真配置。

	Attributes:
		pkt_bits (int): 包长度（比特）。
		snr_db (float): 信噪比 (dB)。
		modulation (str): 调制方式。
	"""
	pkt_bits: int
	snr_db: float
	modulation: str
```

---

## 9. 常见错误示例与修正

| 错误 | 问题 | 推荐写法 |
|------|------|----------|
| 未写类型 | 工具无法推断 | `data (list[str]): 输入数据。` |
| 中英文混杂且无单位 | 语义不完整 | `freq_offset_hz (float): 载波频偏 (Hz)。` |
| 描述出现“见上面” | 不自包含 | 直接写完整说明 |
| 冗余 Returns: None | 没有信息量 | 省略 Returns 段 |
| Raises 列出所有内置异常 | 噪声过大 | 仅列出可预期且语义契约的一部分 |

---

## 10. 与 MkDocs 集成

使用 `mkdocstrings` 插件示例（`mkdocs.yml`）：

```yaml
plugins:
  - mkdocstrings:
	  handlers:
		python:
		  options:
			docstring_style: google
			show_source: true
			separate_signature: true
			show_root_heading: true
			heading_level: 2
```

在文档中引用：

```markdown
::: src.cal.add
::: src.cal.divide
```

---

## 11. 快速模板（可复制）

```python
def func(arg1: int, arg2: str | None = None) -> list[str]:
	"""一句话描述。

	更详细的说明，可多行。

	Args:
		arg1 (int): 作用、范围、单位。
		arg2 (str | None, optional): 何时使用，默认行为。

	Returns:
		list[str]: 每个元素代表……

	Raises:
		ValueError: 条件不满足时。

	Example:
		>>> func(3)
		['a', 'b']
	"""
	...
```

---

## 12. 编写 Checklist

在提交前自检：

* [ ] 全部公共 API 是否有 docstring？
* [ ] 首行是否简洁、句号结尾？
* [ ] 参数列表是否与函数签名一致且顺序相同？
* [ ] 是否遗漏可选参数的默认值说明？
* [ ] 是否标注单位/范围/可空性？
* [ ] 是否只列出真实可能抛出的异常？
* [ ] 示例能否直接复制运行？
* [ ] 是否避免重复描述（类与 `__init__`）？

---

## 13. 参考链接

* Google Style Guide: https://google.github.io/styleguide/pyguide.html#38-comments-and-docstrings
* PEP 257: https://peps.python.org/pep-0257/
* PEP 484: https://peps.python.org/pep-0484/
* MkDocStrings: https://mkdocstrings.github.io/

---

如需补充 NumPy / reST / Google 三种风格对比，可在本页追加附录。
















